<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SparQ Login</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    label { display:block; font-size:14px; margin-bottom:6px; color:#94a3b8; }
  </style>
  <script>
    async function doLogin(e){
      e.preventDefault();
      const form = e.currentTarget;
      const fd = new FormData(form);
      const username = fd.get('username');
      const password = fd.get('password');
      const params = new URLSearchParams(window.location.search);
      const returnTo = params.get('returnTo') || params.get('rt') || '';
      const err = document.getElementById('err');
      err.style.display = 'none';
      try {
        // 1) SSO login at apex (first-party cookies on .getsparqd.com)
        const r = await fetch('/sso/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify({ username, password, returnTo }) });
        const j = await r.json();
        if (!r.ok || !j.success) throw new Error(j.error || 'Login failed');
        // 2) If returnTo present and safe, honor it
        const rt = j.redirect || returnTo;
        const isSafe = (url) => /^https:\/\/(?:[\w-]+\.)*getsparqd\.com(?![^\s]*\s)/.test(url);
        if (rt && isSafe(rt)) { window.location.href = rt; return; }
        // 3) Otherwise, get role-based SparQ Plug entry URL from portal API and navigate
        // Try both direct portal and /sso-prefixed paths to cover reverse-proxy setups
        const candidates = [
          'https://portal.getsparqd.com/api/sparqplug/url',
          '/sso/../api/sparqplug/url'
        ];
        let url;
        for (const u of candidates) {
          try {
            const pr = await fetch(u, { credentials:'include' });
            if (pr.ok) { const pj = await pr.json(); if (pj && pj.url) { url = pj.url; break; } }
          } catch (_) { /* try next */ }
        }
        if (url && isSafe(url)) { window.location.href = url; return; }
        // 4) Fallback to portal dashboard
        window.location.href = 'https://portal.getsparqd.com/dashboard';
      } catch (e) {
        err.textContent = e.message || 'Login failed';
        err.style.display = 'block';
      }
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('login-form').addEventListener('submit', doLogin);
    });
  </script>
</head>
<body class="login-wrap">
  <div class="login-card">
    <h1 class="login-title">Welcome to SparQ</h1>
    <p class="login-subtitle">Sign in to continue</p>
    <div id="err" class="login-error"></div>
    <form id="login-form">
      <div class="mb-12">
        <label for="username">Username or Email</label>
        <input class="login-input" id="username" name="username" type="text" autocomplete="username" required />
      </div>
      <div class="mb-16">
        <label for="password">Password</label>
        <input class="login-input" id="password" name="password" type="password" autocomplete="current-password" required />
      </div>
      <button class="login-button" type="submit">Sign In</button>
    </form>
    <p class="login-muted">Youâ€™ll be redirected to your dashboard.</p>
  </div>
</body>
</html>
